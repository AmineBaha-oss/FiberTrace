<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FiberTrace - Industrial Sorting Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", "Segoe UI", -apple-system, BlinkMacSystemFont,
          sans-serif;
        background: #0a0e27;
        color: #e0e6ed;
        min-height: 100vh;
        padding: 0;
        overflow-x: hidden;
      }

      .header {
        background: linear-gradient(135deg, #1a1f3a 0%, #0f1419 100%);
        border-bottom: 2px solid #2d3748;
        padding: 20px 40px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .logo {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
      }

      .header-title h1 {
        font-size: 1.8em;
        color: #ffffff;
        font-weight: 700;
        margin-bottom: 4px;
      }

      .header-title p {
        font-size: 0.9em;
        color: #94a3b8;
      }

      .status-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: #1e293b;
        border-radius: 8px;
        border: 1px solid #334155;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #10b981;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 30px;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .metric-card {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border: 1px solid #334155;
        border-radius: 16px;
        padding: 24px;
        transition: all 0.3s ease;
      }

      .metric-card:hover {
        border-color: #4f46e5;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(79, 70, 229, 0.2);
      }

      .metric-label {
        font-size: 0.85em;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 12px;
        font-weight: 600;
      }

      .metric-value {
        font-size: 2.8em;
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 8px;
      }

      .metric-change {
        font-size: 0.9em;
        color: #10b981;
      }

      .metric-card.throughput .metric-value {
        color: #60a5fa;
      }
      .metric-card.purity .metric-value {
        color: #34d399;
      }
      .metric-card.cotton .metric-value {
        color: #4ade80;
      }
      .metric-card.blend .metric-value {
        color: #f87171;
      }
      .metric-card.polyester .metric-value {
        color: #818cf8;
      }

      .main-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .panel {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border: 1px solid #334155;
        border-radius: 16px;
        padding: 30px;
      }

      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #334155;
      }

      .panel-title {
        font-size: 1.3em;
        font-weight: 700;
        color: #ffffff;
      }

      .camera-preview-container {
        position: relative;
        width: 100%;
        background: #0a0e27;
        border-radius: 12px;
        overflow: hidden;
        border: 2px solid #334155;
      }

      .camera-preview {
        width: 100%;
        display: block;
        max-height: 500px;
        object-fit: contain;
      }

      .scan-controls {
        margin-top: 20px;
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .scan-button {
        flex: 1;
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        border: none;
        padding: 16px 32px;
        font-size: 1.1em;
        font-weight: 600;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
      }

      .scan-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(79, 70, 229, 0.6);
      }

      .scan-button:active:not(:disabled) {
        transform: translateY(0);
      }

      .scan-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .result-badge {
        padding: 12px 24px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 1.1em;
        text-align: center;
      }

      .result-badge.good {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
      }

      .result-badge.bad {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
      }

      .result-badge.pure-poly {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
      }

      .purity-gauge {
        text-align: center;
        margin: 30px 0;
      }

      .gauge-circle {
        width: 220px;
        height: 220px;
        margin: 0 auto;
        position: relative;
        border-radius: 50%;
        background: conic-gradient(
          #10b981 0deg,
          #10b981 calc(var(--purity) * 3.6deg),
          #334155 calc(var(--purity) * 3.6deg),
          #334155 360deg
        );
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
      }

      .gauge-inner {
        width: 170px;
        height: 170px;
        background: #1e293b;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border: 3px solid #334155;
      }

      .gauge-value {
        font-size: 3em;
        font-weight: 700;
        color: #10b981;
      }

      .gauge-label {
        font-size: 0.9em;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 5px;
      }

      .certificate-section {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border: 1px solid #334155;
        border-radius: 16px;
        padding: 30px;
        margin-top: 30px;
      }

      .certificate-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #334155;
      }

      .cert-badge {
        display: inline-block;
        padding: 8px 16px;
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        border-radius: 8px;
        font-size: 0.85em;
        font-weight: 600;
        color: white;
      }

      .stats-table {
        width: 100%;
        border-collapse: collapse;
      }

      .stats-table th,
      .stats-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #334155;
      }

      .stats-table th {
        color: #94a3b8;
        font-weight: 600;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stats-table td {
        color: #e0e6ed;
        font-weight: 500;
      }

      .stats-table tr:hover {
        background: #1e293b;
      }

      .last-update {
        text-align: center;
        color: #64748b;
        margin-top: 20px;
        font-size: 0.9em;
      }

      @media (max-width: 1200px) {
        .main-content {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .header {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .metrics-grid {
          grid-template-columns: 1fr;
        }

        .container {
          padding: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-left">
        <div class="logo">FT</div>
        <div class="header-title">
          <h1>FiberTrace</h1>
          <p>Industrial Sorting Dashboard</p>
        </div>
      </div>
      <div class="status-badge">
        <div class="status-dot"></div>
        <span>System Operational</span>
      </div>
    </div>

    <div class="container">
      <div class="metrics-grid">
        <div class="metric-card throughput">
          <div class="metric-label">Total Items Scanned</div>
          <div class="metric-value" id="total">0</div>
          <div class="metric-change">Real-time processing</div>
        </div>

        <div class="metric-card purity">
          <div class="metric-label">Bale Purity</div>
          <div class="metric-value" id="purity">0%</div>
          <div class="metric-change">Target: 98%+</div>
        </div>

        <div class="metric-card cotton">
          <div class="metric-label">Pure Cotton</div>
          <div class="metric-value" id="good">0</div>
          <div class="metric-change">Certified pure</div>
        </div>

        <div class="metric-card blend">
          <div class="metric-label">Blend Detected</div>
          <div class="metric-value" id="bad">0</div>
          <div class="metric-change">Mixed materials</div>
        </div>
      </div>

      <div class="main-content">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Live Camera Feed</div>
          </div>
          <div class="camera-preview-container">
            <img
              id="cameraPreview"
              src="/api/camera/preview"
              alt="Camera Feed"
              class="camera-preview"
            />
          </div>
          <div class="scan-controls">
            <button id="scanButton" class="scan-button" onclick="triggerScan()">
              üîç Scan Item
            </button>
            <div id="scanResult"></div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Purity Gauge</div>
          </div>
          <div class="purity-gauge">
            <div class="gauge-circle" id="purityCircle">
              <div class="gauge-inner">
                <div class="gauge-value" id="purityPercent">0%</div>
                <div class="gauge-label">Purity</div>
              </div>
            </div>
          </div>
          <div class="last-update">
            <span
              class="status-dot"
              style="display: inline-block; margin-right: 8px"
            ></span>
            Last updated: <span id="lastUpdate">Never</span>
          </div>
        </div>
      </div>

      <div class="certificate-section">
        <div class="certificate-header">
          <div class="panel-title">Production Statistics</div>
          <span class="cert-badge">FiberTrace Certified</span>
        </div>
        <table class="stats-table">
          <thead>
            <tr>
              <th>Metric</th>
              <th>Value</th>
              <th>Status</th>
              <th>Last Update</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Total Items Processed</td>
              <td id="tableTotal">0</td>
              <td><span style="color: #10b981">‚óè</span> Active</td>
              <td id="tableUpdate">Never</td>
            </tr>
            <tr>
              <td>Pure Cotton Items</td>
              <td id="tableGood">0</td>
              <td><span style="color: #4ade80">‚óè</span> Certified</td>
              <td id="tableUpdate">-</td>
            </tr>
            <tr>
              <td>Blend Detections</td>
              <td id="tableBad">0</td>
              <td><span style="color: #f87171">‚óè</span> Segregated</td>
              <td id="tableUpdate">-</td>
            </tr>
            <tr>
              <td>Current Bale Purity</td>
              <td id="tablePurity">0%</td>
              <td id="purityStatus">
                <span style="color: #94a3b8">‚óè</span> Pending
              </td>
              <td id="tableUpdate">-</td>
            </tr>
            <tr>
              <td>Last Scan Result</td>
              <td id="tableResult">-</td>
              <td id="resultStatus">-</td>
              <td id="tableUpdate">-</td>
            </tr>
            <tr>
              <td>Last Item Purity</td>
              <td id="tableItemPurity">-</td>
              <td id="tableComposition">-</td>
              <td id="tableUpdate">-</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>
      function updateDashboard() {
        fetch("/api/stats")
          .then((response) => response.json())
          .then((data) => {
            // Update main metrics
            document.getElementById("total").textContent =
              data.total_scanned.toLocaleString();
            document.getElementById("good").textContent =
              data.good_count.toLocaleString();
            document.getElementById("bad").textContent =
              data.bad_count.toLocaleString();
            document.getElementById("purity").textContent = data.purity + "%";
            document.getElementById("purityPercent").textContent =
              data.purity + "%";
            document.getElementById("lastUpdate").textContent =
              data.last_update;

            // Update table
            document.getElementById("tableTotal").textContent =
              data.total_scanned.toLocaleString();
            document.getElementById("tableGood").textContent =
              data.good_count.toLocaleString();
            document.getElementById("tableBad").textContent =
              data.bad_count.toLocaleString();
            document.getElementById("tablePurity").textContent =
              data.purity + "%";

            if (data.last_result) {
              document.getElementById("tableResult").textContent =
                data.last_result;
              const resultStatus = document.getElementById("resultStatus");
              if (data.last_result === "GOOD") {
                resultStatus.innerHTML =
                  '<span style="color: #4ade80;">‚óè</span> Pure Cotton';
              } else {
                resultStatus.innerHTML =
                  '<span style="color: #f87171;">‚óè</span> Blend Detected';
              }
            }
            
            // Update item purity info
            if (data.last_item_purity !== null && data.last_item_purity !== undefined) {
              document.getElementById("tableItemPurity").textContent = data.last_item_purity + "%";
              document.getElementById("tableComposition").textContent = data.last_composition || "-";
            }

            // Update purity status
            const purityStatus = document.getElementById("purityStatus");
            if (data.purity >= 98) {
              purityStatus.innerHTML =
                '<span style="color: #10b981;">‚óè</span> Certified (98%+)';
            } else if (data.purity >= 90) {
              purityStatus.innerHTML =
                '<span style="color: #fbbf24;">‚óè</span> Good';
            } else {
              purityStatus.innerHTML =
                '<span style="color: #f87171;">‚óè</span> Needs Improvement';
            }

            // Update purity circle gauge
            const circle = document.getElementById("purityCircle");
            if (circle) {
              circle.style.setProperty("--purity", data.purity);
              // Force a reflow to ensure CSS variable update is applied
              circle.offsetHeight;
            }
          })
          .catch((error) => {
            console.error("Error fetching stats:", error);
          });
      }

      function updateCameraPreview() {
        // Only update when a scan is performed, not automatically
        const img = document.getElementById("cameraPreview");
        img.src = "/api/camera/preview?t=" + new Date().getTime();
      }

      function triggerScan() {
        const button = document.getElementById("scanButton");
        const resultDiv = document.getElementById("scanResult");

        button.disabled = true;
        button.textContent = "Scanning...";

        fetch("/api/scan", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              let badgeClass = "bad";
              if (data.result === "GOOD") badgeClass = "good";
              
              // Show result with purity info
              let resultText = `${data.result}`;
              if (data.purity !== undefined) {
                resultText += ` - ${data.purity}%`;
              }
              if (data.composition) {
                resultText += `<br><small style="font-size: 0.8em; opacity: 0.9;">${data.composition}</small>`;
              }
              resultDiv.innerHTML = `<div class="result-badge ${badgeClass}">${resultText}</div>`;
              
              // Wait a bit for data to be saved, then update dashboard
              setTimeout(() => {
                updateDashboard();
                updateCameraPreview();
              }, 300);
            } else {
              resultDiv.innerHTML = `<div class="result-badge bad">Error: ${
                data.error || "Unknown"
              }</div>`;
            }
          })
          .catch((error) => {
            resultDiv.innerHTML = `<div class="result-badge bad">Error: ${error.message}</div>`;
          })
          .finally(() => {
            button.disabled = false;
            button.textContent = "üîç Scan Item";
          });
      }

      // Initialize
      updateDashboard();
      setInterval(updateDashboard, 2000);
      // Don't auto-update camera - only show last scanned image
      updateCameraPreview(); // Load once on page load
    </script>
  </body>
</html>
